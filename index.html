<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Calculadora ETc - Gesti√≥n de Riego Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 20px; background-color: #f1f5f9; color: #1e293b; }
        .container { max-width: 1000px; margin: auto; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .header-step { border-left: 5px solid #2563eb; padding-left: 15px; margin-bottom: 20px; color: #1e3a8a; font-weight: bold; font-size: 1.2em; }
        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; background: #2563eb; color: white; }
        .btn-calc { background: #16a34a; width: 100%; margin-top: 15px; font-size: 1.1em; }
        .input-group { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px; align-items: center; }
        input, select { padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th, td { border: 1px solid #e2e8f0; padding: 12px; text-align: center; }
        th { background: #f8fafc; color: #1e3a8a; }
        .highlight { font-weight: bold; color: #166534; background: #dcfce7; }
        .result-box { background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; margin-top: 15px; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <div class="header-step">üìç Secci√≥n 1: Localizar Estaci√≥n AEMET</div>
        <div class="input-group">
            Lat: <input type="number" id="lat" value="39.44" step="0.01">
            Lon: <input type="number" id="lon" value="-0.74" step="0.01">
            <button class="btn" onclick="buscarEstacion()">Buscar Estaci√≥n Cercana</button>
        </div>
        <div id="infoEstacion" class="result-box" style="display:none"></div>
    </div>

    <div class="card">
        <div class="header-step">üíß Secci√≥n 2: C√°lculo de ETc y Consumo (m¬≥/ha)</div>
        <div class="input-group">
            Cultivo: <select id="selectCultivo"><option>Cargando lista...</option></select>
            Inicio: <input type="month" id="fechaIni" value="2024-01">
            Fin: <input type="month" id="fechaFin" value="2024-12">
        </div>
        <p>Carga el JSON de AEMET (con datos de <code>eto_mes</code>):</p>
        <input type="file" id="jsonFile" accept=".json">
        
        <button class="btn btn-calc" onclick="procesarRiego()">Calcular Necesidades de Riego</button>

        <div id="panelResultados" style="display:none">
            <table id="tablaEtc">
                <thead>
                    <tr>
                        <th>Mes</th>
                        <th>ETo (mm)</th>
                        <th>Kc (Mes)</th>
                        <th>ETc (mm)</th>
                        <th>Riego (m¬≥/ha)</th>
                    </tr>
                </thead>
                <tbody id="cuerpoEtc"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
let cultivosData = [];
const formatNum = { minimumFractionDigits: 1, maximumFractionDigits: 1 };

// Cargar cultivos desde el JSON
fetch('cultivos.json')
    .then(r => r.json())
    .then(data => {
        cultivosData = data;
        const select = document.getElementById('selectCultivo');
        select.innerHTML = data.map((c, index) => `<option value="${index}">${c.nombre}</option>`).join('');
    });

// --- L√ìGICA DE B√öSQUEDA (IGUAL AL PROYECTO ANTERIOR) ---
function aemetToDec(c) {
    if(!c) return 0;
    const d = c.slice(-1), n = c.slice(0,-1);
    const s = parseFloat(n.slice(-2)), m = parseFloat(n.slice(-4,-2)), g = parseFloat(n.slice(0, n.length-4));
    const dec = g + (m/60) + (s/3600);
    return (d === 'S' || d === 'W') ? -dec : dec;
}

function buscarEstacion() {
    fetch('estaciones.json').then(r => r.json()).then(ests => {
        const uLat = parseFloat(document.getElementById('lat').value);
        const uLon = parseFloat(document.getElementById('lon').value);
        let m = null, dMin = Infinity;
        ests.forEach(e => {
            const d = Math.sqrt(Math.pow(uLat - aemetToDec(e.latitud), 2) + Math.pow(uLon - aemetToDec(e.longitud), 2));
            if(d < dMin) { dMin = d; m = e; }
        });
        const res = document.getElementById('infoEstacion');
        res.style.display = "block";
        res.innerHTML = `‚úÖ <strong>Estaci√≥n:</strong> ${m.nombre} | <strong>C√≥d:</strong> <span style="color:red">${m.indicativo}</span>`;
    });
}

// --- L√ìGICA MATEM√ÅTICA ETc ---
function procesarRiego() {
    const file = document.getElementById('jsonFile').files[0];
    if(!file) return alert("Por favor, sube el archivo JSON de AEMET");

    const reader = new FileReader();
    reader.onload = (e) => {
        const aemet = JSON.parse(e.target.result);
        const cultivo = cultivosData[document.getElementById('selectCultivo').value];
        const fIni = document.getElementById('fechaIni').value;
        const fFin = document.getElementById('fechaFin').value;
        
        const cuerpo = document.getElementById('cuerpoEtc');
        cuerpo.innerHTML = "";

        // Filtrar datos de AEMET por rango de fechas
        const filtrados = aemet.filter(d => {
            const f = d.fecha.substring(0,7);
            return f >= fIni && f <= fFin && !f.endsWith("-13");
        });

        filtrados.forEach(d => {
            const mesNumero = parseInt(d.fecha.split('-')[1]);
            const eto = parseFloat(String(d.eto_mes || d.evap_mes || "0").replace(',','.'));
            
            // BUSCAR Kc EN LA TABLA MAESTRA SEG√öN EL MES
            const kcMes = cultivo.kc[mesNumero] || 0.1;
            
            // C√ÅLCULOS
            const etc = eto * kcMes;
            const m3ha = etc * 10;

            cuerpo.innerHTML += `
                <tr>
                    <td>${d.fecha}</td>
                    <td>${eto.toLocaleString('es-ES', formatNum)}</td>
                    <td>${kcMes.toFixed(2)}</td>
                    <td class="highlight">${etc.toLocaleString('es-ES', formatNum)} mm</td>
                    <td class="highlight">${m3ha.toLocaleString('es-ES', {maximumFractionDigits:0})} m¬≥/ha</td>
                </tr>
            `;
        });

        document.getElementById('panelResultados').style.display = "block";
    };
    reader.readAsText(file);
}
</script>
</body>
</html>
